machine:
  xcode:
    version: "8.1"
  environment:
    default_destination: platform=iOS Simulator,name=iPhone 6,OS=9.0

dependencies:
  pre:
    - sudo gem install jazzy
    - sudo gem install ocunit2junit
    - sudo gem install rubygems-update
    - sudo update_rubygems
test:
  pre:
    # This is workaround.
    # xcinvoke-0.2.1 is not adapt Xcode 8.
    # xcinvoke-0.2.1 is used from jazzy-0.7.2.
    # So we need to fix to generate document with this workaround.
    # ref: https://github.com/segiddins/xcinvoke/issues/6
    - sed "s/cmd = \[@xcrun_path\] + cmd/cmd = \['xcrun'\] + cmd/g" /opt/rubies/ruby-2.3.1/lib/ruby/gems/2.3.0/gems/xcinvoke-0.2.1/lib/xcinvoke/xcode.rb > xcode.rb
    - sudo mv xcode.rb /opt/rubies/ruby-2.3.1/lib/ruby/gems/2.3.0/gems/xcinvoke-0.2.1/lib/xcinvoke
    # Build sdk
    - cd ThingIFSDK; make all
    # Copy docs to artifacts
    - cp ThingIFSDK/Documentation/*.zip $CIRCLE_ARTIFACTS
    - cp -fr ThingIFSDK/Documentation/docs $CIRCLE_ARTIFACTS/
  override:
    # run small tests
    - if [ ! -n "$DESTINATION" ]; then DESTINATION=$default_destination; fi;
      cd ThingIFSDK;
      python testScripts/xcodebuildtest.py  --destination "${DESTINATION}"

    - cp ThingIFSDK/test-reports/*.xml $CIRCLE_TEST_REPORTS/
